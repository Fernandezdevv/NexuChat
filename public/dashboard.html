<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Pro - Closer AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; overflow-x: hidden; }
        .stat-card { background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid #e2e8f0; height: 100%; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-slate-800">Relatórios de Vendas</h1>
                <p class="text-sm md:text-base text-slate-500">Métricas exclusivas de pedidos <span class="font-bold text-emerald-600">concluídos</span></p>
            </div>
            <a href="index.html" class="w-full md:w-auto text-center bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-800 transition">Voltar ao Painel</a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
            <div class="stat-card border-b-4 border-b-blue-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Faturamento Real</p>
                <h2 id="total-vendas" class="text-2xl md:text-3xl font-black text-slate-800">R$ 0,00</h2>
            </div>
            <div class="stat-card border-b-4 border-b-indigo-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Vendas Finalizadas</p>
                <h2 id="total-pedidos" class="text-2xl md:text-3xl font-black text-slate-800">0</h2>
            </div>
            <div class="stat-card border-b-4 border-b-emerald-500 shadow-sm sm:col-span-2 md:col-span-1">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Ticket Médio</p>
                <h2 id="ticket-medio" class="text-2xl md:text-3xl font-black text-emerald-600">R$ 0,00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
            <div class="stat-card shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-blue-500 rounded-full"></span> Evolução de Faturamento
                </h3>
                <div class="chart-container"><canvas id="chart-bolsa"></canvas></div>
            </div>

            <div class="stat-card shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-indigo-500 rounded-full"></span> Origem da Receita
                </h3>
                <div class="chart-container"><canvas id="chart-pagamento"></canvas></div>
            </div>

            <div class="stat-card shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Volume de Pedidos
                </h3>
                <div class="chart-container"><canvas id="chart-volume"></canvas></div>
            </div>

            <div class="stat-card shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-purple-500 rounded-full"></span> Eficiência do Funil
                </h3>
                <div class="chart-container"><canvas id="chart-status"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
    const id = localStorage.getItem('id_empresa');
    const path = window.location.pathname;
    
    // Se não tiver ID e não estiver no login/cadastro, expulsa
    if (!id && !path.includes('login.html') && !path.includes('cadastro.html')) {
        window.location.href = 'login.html';
    }
})();
        const idEmpresa = localStorage.getItem('id_empresa') || 1;
        let chartInstances = {};

        async function carregarDashboard() {
            try {
                const res = await fetch(`/api/dashboard/vendas?id_empresa=${idEmpresa}`);
                const data = await res.json();

                document.getElementById('total-vendas').innerText = `R$ ${parseFloat(data.resumo.totalVendas).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-pedidos').innerText = data.resumo.totalPedidos;
                document.getElementById('ticket-medio').innerText = `R$ ${parseFloat(data.resumo.ticketMedio).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                renderizarTudo(data);
            } catch (err) {
                console.error("Erro ao carregar dashboard:", err);
            }
        }

        function renderizarTudo(data) {
            Object.values(chartInstances).forEach(c => c.destroy());

            // 1. Evolução
            const ctxBolsa = document.getElementById('chart-bolsa').getContext('2d');
            const grad = ctxBolsa.createLinearGradient(0, 0, 0, 350);
            grad.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
            grad.addColorStop(1, 'rgba(59, 130, 246, 0)');

            chartInstances.bolsa = new Chart(ctxBolsa, {
                type: 'line',
                data: {
                    labels: data.vendasDiarias.map(v => {
                        const [ano, mes, dia] = v.data.split('-');
                        return `${dia}/${mes}`;
                    }),
                    datasets: [{ label: 'Vendas', data: data.vendasDiarias.map(v => v.valor), borderColor: '#3b82f6', backgroundColor: grad, fill: true, tension: 0.4, borderWidth: 3 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: {display: false} } }
            });

            // 2. Pagamento
            chartInstances.pag = new Chart(document.getElementById('chart-pagamento'), {
                type: 'doughnut',
                data: {
                    labels: data.vendasPorPagamento.map(p => p.forma_pagamento.toUpperCase()),
                    datasets: [{ data: data.vendasPorPagamento.map(p => p.total), backgroundColor: ['#3b82f6', '#6366f1', '#10b981', '#f59e0b'] }]
                },
                options: { maintainAspectRatio: false, cutout: '70%' }
            });

            // 3. Volume
            chartInstances.vol = new Chart(document.getElementById('chart-volume'), {
                type: 'bar',
                data: {
                    labels: data.vendasDiarias.map(v => {
                        const [ano, mes, dia] = v.data.split('-');
                        return `${dia}/${mes}`;
                    }),
                    datasets: [{
                        label: 'Qtd Pedidos',
                        data: data.vendasDiarias.map(v => v.qtd),
                        backgroundColor: '#10b981',
                        borderRadius: 8,
                        barThickness: 'flex'
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } 
                }
            });

            // 4. Status
            chartInstances.status = new Chart(document.getElementById('chart-status'), {
                type: 'bar',
                data: {
                    labels: data.pedidosPorStatus.map(s => s.status.toUpperCase()),
                    datasets: [{ data: data.pedidosPorStatus.map(s => s.count), backgroundColor: '#6366f1', borderRadius: 8 }]
                },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: {display: false} } }
            });
        }

        window.onload = carregarDashboard;
    </script>
</body>
</html>